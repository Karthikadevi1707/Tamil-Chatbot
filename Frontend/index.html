<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="UTF-8">
<title>à®¤à®®à®¿à®´à¯ AI Assistant</title>

<style>
body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    display:flex;
    height:100vh;
}

/* SIDEBAR */
.sidebar{
    width:260px;
    background:#202123;
    color:white;
    padding:15px;
    display:flex;
    flex-direction:column;
}
.sidebar button{
    padding:10px;
    margin-bottom:10px;
    border:none;
    border-radius:6px;
    cursor:pointer;
}
.new-btn{background:#10a37f;color:white;}
.clear-btn{background:#ff4b5c;color:white;}

.chat-list{flex:1;overflow-y:auto;}
.chat-item{
    padding:8px;
    margin-bottom:5px;
    background:#343541;
    border-radius:6px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:14px;
}
.chat-item span{flex:1;cursor:pointer;}
.delete-btn{
    background:red;
    border:none;
    color:white;
    padding:3px 6px;
    border-radius:4px;
    cursor:pointer;
}

/* MAIN */
.main{
    flex:1;
    display:flex;
    flex-direction:column;
    background:#f4f6f9;
}
.chat-area{
    flex:1;
    padding:20px;
    overflow-y:auto;
}
.message{
    margin-bottom:15px;
    max-width:75%;
    padding:15px;
    border-radius:12px;
    line-height:1.6;
    word-wrap:break-word;
}
.user{
    background:#0084ff;
    color:white;
    margin-left:auto;
}
.bot{
    background:linear-gradient(135deg,#ffffff,#e6f0ff);
    border-left:5px solid #10a37f;
}

/* INPUT AREA */
.input-area{
    display:flex;
    align-items:center;
    padding:10px;
    border-top:1px solid #ccc;
    background:white;
}
input[type="text"]{
    flex:1;
    padding:10px;
    border-radius:20px;
    border:1px solid #ccc;
}
button{
    margin-left:5px;
    padding:8px 12px;
    border:none;
    border-radius:20px;
    background:#0084ff;
    color:white;
    cursor:pointer;
}
.mic{background:#ff4b5c;}
.toggle{background:#555;}
</style>
</head>

<body>

<div class="sidebar">
    <button class="new-btn" onclick="newChat()">ğŸ†• à®ªà¯à®¤à®¿à®¯ à®‰à®°à¯ˆà®¯à®¾à®Ÿà®²à¯</button>
    <button class="clear-btn" onclick="clearAllChats()">ğŸ—‘ à®…à®©à¯ˆà®¤à¯à®¤à¯à®®à¯ Delete</button>
    <div class="chat-list" id="chatList"></div>
</div>

<div class="main">
    <div class="chat-area" id="chatArea"></div>

    <div class="input-area">
        <input type="file" id="fileInput">
        <input type="text" id="question" placeholder="à®‰à®™à¯à®•à®³à¯ à®•à¯‡à®³à¯à®µà®¿à®¯à¯ˆ à®à®´à¯à®¤à¯à®™à¯à®•à®³à¯...">

        <button class="toggle" id="voiceToggle" onclick="toggleVoice()">ğŸ”‡ Voice OFF</button>
        <button class="mic" onclick="startVoice()">ğŸ¤</button>

        <button onclick="sendMessage()">à®…à®©à¯à®ªà¯à®ªà¯</button>
        <button onclick="sendImageQuestion()">ğŸ“·</button>
        <button onclick="sendPDF()">ğŸ“„</button>
        <button onclick="generateImage()">ğŸ¨</button>
    </div>
</div>

<script>

let chats = JSON.parse(localStorage.getItem("tamilChats")) || {};
let currentChatId = null;
let voiceEnabled = false;

/* SAVE */
function saveChats(){
    localStorage.setItem("tamilChats", JSON.stringify(chats));
}

/* NEW CHAT */
function newChat(){
    currentChatId = "chat_" + Date.now();
    chats[currentChatId] = [];
    saveChats();
    renderChatList();
    renderMessages();
}

/* DELETE SINGLE */
function deleteChat(id){
    if(confirm("à®‡à®¨à¯à®¤ à®‰à®°à¯ˆà®¯à®¾à®Ÿà®²à¯ˆ delete à®šà¯†à®¯à¯à®¯à®µà®¾?")){
        delete chats[id];
        if(currentChatId===id) currentChatId=null;
        saveChats();
        renderChatList();
        renderMessages();
    }
}

/* CLEAR ALL */
function clearAllChats(){
    if(confirm("à®…à®©à¯ˆà®¤à¯à®¤à¯ history-à®¯à¯à®®à¯ delete à®šà¯†à®¯à¯à®¯à®µà®¾?")){
        chats={};
        currentChatId=null;
        saveChats();
        renderChatList();
        renderMessages();
    }
}

/* SIDEBAR RENDER */
function renderChatList(){
    const list=document.getElementById("chatList");
    list.innerHTML="";
    Object.keys(chats).forEach(id=>{
        const div=document.createElement("div");
        div.className="chat-item";

        const span=document.createElement("span");
        span.innerText=chats[id][0]?.text||"à®ªà¯à®¤à®¿à®¯ à®‰à®°à¯ˆà®¯à®¾à®Ÿà®²à¯";
        span.onclick=()=>{currentChatId=id;renderMessages();};

        const del=document.createElement("button");
        del.className="delete-btn";
        del.innerText="âŒ";
        del.onclick=()=>deleteChat(id);

        div.appendChild(span);
        div.appendChild(del);
        list.appendChild(div);
    });
}

/* MESSAGE RENDER */
function renderMessages(){
    const area=document.getElementById("chatArea");
    area.innerHTML="";
    if(!currentChatId) return;

    chats[currentChatId].forEach((msg,index)=>{
        const div=document.createElement("div");
        div.className="message "+msg.type;

        if(msg.type==="bot"){
            div.innerHTML=msg.text.replace(/\n/g,"<br>")+
            `<br><button onclick="manualSpeak(this)">ğŸ”Š à®•à¯‡à®³à¯</button>`;
            if(voiceEnabled && index===chats[currentChatId].length-1){
                speakText(msg.text);
            }
        }else{
            div.innerHTML=msg.text.replace(/\n/g,"<br>");
        }

        area.appendChild(div);
    });

    area.scrollTop=area.scrollHeight;
}

/* TEXT QUESTION */
async function sendMessage(){
    const input=document.getElementById("question");
    const question=input.value.trim();
    if(!question) return;

    if(!currentChatId) newChat();

    chats[currentChatId].push({type:"user",text:question});
    renderMessages(); saveChats();
    input.value="";

    const res=await fetch("http://127.0.0.1:9000/ask",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({question})
    });

    const data=await res.json();
    chats[currentChatId].push({type:"bot",text:data.answer});
    renderMessages(); saveChats();
}

/* IMAGE QUESTION */
async function sendImageQuestion(){
    const file=document.getElementById("fileInput").files[0];
    if(!file){alert("Image à®¤à¯‡à®°à¯à®µà¯ à®šà¯†à®¯à¯à®¯à®µà¯à®®à¯");return;}

    if(!currentChatId) newChat();

    const formData=new FormData();
    formData.append("file",file);

    chats[currentChatId].push({type:"user",text:"ğŸ“· Image Upload"});
    renderMessages(); saveChats();

    const res=await fetch("http://127.0.0.1:9000/image-question",{
        method:"POST",
        body:formData
    });

    const data=await res.json();
    chats[currentChatId].push({type:"bot",text:data.answer});
    renderMessages(); saveChats();
}

/* PDF */
async function sendPDF(){
    const file=document.getElementById("fileInput").files[0];
    if(!file){alert("PDF à®¤à¯‡à®°à¯à®µà¯ à®šà¯†à®¯à¯à®¯à®µà¯à®®à¯");return;}

    if(!currentChatId) newChat();

    const formData=new FormData();
    formData.append("file",file);

    chats[currentChatId].push({type:"user",text:"ğŸ“„ PDF Upload"});
    renderMessages(); saveChats();

    const res=await fetch("http://127.0.0.1:9000/pdf-question",{
        method:"POST",
        body:formData
    });

    const data=await res.json();
    chats[currentChatId].push({type:"bot",text:data.answer});
    renderMessages(); saveChats();
}

/* IMAGE GENERATE */
async function generateImage(){
    const input=document.getElementById("question");
    const prompt=input.value.trim();
    if(!prompt) return;

    if(!currentChatId) newChat();

    chats[currentChatId].push({type:"user",text:"ğŸ¨ "+prompt});
    renderMessages(); saveChats();
    input.value="";

    const res=await fetch("http://127.0.0.1:9000/generate-image",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({prompt})
    });

    const data=await res.json();

    if(data.image_url){
        chats[currentChatId].push({
            type:"bot",
            text:`<img src="${data.image_url}" width="350">`
        });
    }else{
        chats[currentChatId].push({
            type:"bot",
            text:"Image à®‰à®°à¯à®µà®¾à®•à¯à®• à®®à¯à®Ÿà®¿à®¯à®µà®¿à®²à¯à®²à¯ˆ."
        });
    }

    renderMessages(); saveChats();
}

/* VOICE INPUT */
function startVoice(){
    if(!('webkitSpeechRecognition'in window)){
        alert("Voice support à®‡à®²à¯à®²à¯ˆ");
        return;
    }
    const rec=new webkitSpeechRecognition();
    rec.lang="ta-IN";
    rec.start();
    rec.onresult=function(e){
        document.getElementById("question").value=
        e.results[0][0].transcript;
    };
}

/* VOICE OUTPUT */
function speakText(text){
    window.speechSynthesis.cancel();
    if(!voiceEnabled) return;
    const speech=new SpeechSynthesisUtterance(text);
    speech.lang="ta-IN";
    window.speechSynthesis.speak(speech);
}

function manualSpeak(btn){
    const text=btn.parentElement.innerText.replace("ğŸ”Š à®•à¯‡à®³à¯","");
    window.speechSynthesis.cancel();
    const speech=new SpeechSynthesisUtterance(text);
    speech.lang="ta-IN";
    window.speechSynthesis.speak(speech);
}

function toggleVoice(){
    voiceEnabled=!voiceEnabled;
    const btn=document.getElementById("voiceToggle");
    if(!voiceEnabled) window.speechSynthesis.cancel();
    btn.innerText=voiceEnabled?"ğŸ”Š Voice ON":"ğŸ”‡ Voice OFF";
}

renderChatList();

</script>
</body>
</html>