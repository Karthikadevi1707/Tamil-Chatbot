<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="UTF-8">
<title>à®¤à®®à®¿à®´à¯ à®‡à®²à®•à¯à®•à®¿à®¯ AI</title>

<style>
body{margin:0;font-family:'Segoe UI',sans-serif;display:flex;height:100vh;}
.sidebar{width:260px;background:#202123;color:white;padding:15px;display:flex;flex-direction:column;}
.sidebar button{padding:10px;margin-bottom:15px;background:#10a37f;border:none;border-radius:6px;color:white;cursor:pointer;}
.chat-list{flex:1;overflow-y:auto;}
.chat-item{padding:8px;margin-bottom:5px;background:#343541;border-radius:6px;cursor:pointer;font-size:14px;}
.chat-item:hover{background:#444654;}
.main{flex:1;display:flex;flex-direction:column;background:#f4f6f9;}
.chat-area{flex:1;padding:20px;overflow-y:auto;}
.message{margin-bottom:15px;max-width:75%;padding:15px;border-radius:12px;line-height:1.6;font-size:15px;}
.user{background:#0084ff;color:white;margin-left:auto;}
.bot{background:linear-gradient(135deg,#ffffff,#e6f0ff);border-left:5px solid #10a37f;}
.input-area{display:flex;align-items:center;padding:15px;border-top:1px solid #ccc;background:white;}
input[type="text"]{flex:1;padding:12px;border-radius:20px;border:1px solid #ccc;}
button{margin-left:5px;padding:8px 12px;border:none;border-radius:20px;background:#0084ff;color:white;cursor:pointer;}
.mic{background:#ff4b5c;border-radius:50%;}
.toggle{background:#555;}
</style>
</head>

<body>

<div class="sidebar">
    <button onclick="newChat()">ğŸ†• à®ªà¯à®¤à®¿à®¯ à®‰à®°à¯ˆà®¯à®¾à®Ÿà®²à¯</button>
    <div class="chat-list" id="chatList"></div>
</div>

<div class="main">
    <div class="chat-area" id="chatArea"></div>

    <div class="input-area">
        <input type="file" id="imageInput" accept="image/*">
        <input type="text" id="question" placeholder="à®‰à®™à¯à®•à®³à¯ à®•à¯‡à®³à¯à®µà®¿à®¯à¯ˆ à®à®´à¯à®¤à¯à®™à¯à®•à®³à¯...">
        <button class="toggle" id="voiceToggle" onclick="toggleVoice()">ğŸ”‡ Voice OFF</button>
        <button class="mic" onclick="startVoice()">ğŸ¤</button>
        <button onclick="sendImage()">ğŸ“·</button>
        <button onclick="sendMessage()">à®…à®©à¯à®ªà¯à®ªà¯</button>
    </div>
</div>

<script>

let chats = JSON.parse(localStorage.getItem("tamilChats")) || {};
let currentChatId = null;
let voiceEnabled = false;

function saveChats(){
    localStorage.setItem("tamilChats", JSON.stringify(chats));
}

function newChat(){
    currentChatId = "chat_" + Date.now();
    chats[currentChatId] = [];
    saveChats();
    renderChatList();
    renderMessages();
}

function renderChatList(){
    const chatList = document.getElementById("chatList");
    chatList.innerHTML="";
    Object.keys(chats).forEach(id=>{
        const item=document.createElement("div");
        item.className="chat-item";
        item.innerText=chats[id][0]?.text||"à®ªà¯à®¤à®¿à®¯ à®‰à®°à¯ˆà®¯à®¾à®Ÿà®²à¯";
        item.onclick=()=>{currentChatId=id;renderMessages();};
        chatList.appendChild(item);
    });
}

function renderMessages(){
    const chatArea=document.getElementById("chatArea");
    chatArea.innerHTML="";
    if(!currentChatId) return;

    chats[currentChatId].forEach(msg=>{
        const div=document.createElement("div");
        div.className="message "+msg.type;

        if(msg.type==="bot"){
            div.innerHTML = msg.text.replace(/\n/g,"<br>") +
            `<br><button onclick="manualSpeak(this)">ğŸ”Š à®•à¯‡à®³à¯</button>`;

            // ğŸ”¥ Auto speak only if ON and only for latest message
            if(voiceEnabled && msg === chats[currentChatId][chats[currentChatId].length-1]){
                speakText(msg.text);
            }

        } else {
            div.innerHTML = msg.text.replace(/\n/g,"<br>");
        }

        chatArea.appendChild(div);
    });

    chatArea.scrollTop=chatArea.scrollHeight;
}

async function sendMessage(){
    const input=document.getElementById("question");
    const question=input.value.trim();
    if(!question) return;
    if(!currentChatId) newChat();

    chats[currentChatId].push({type:"user",text:question});
    renderMessages(); saveChats(); input.value="";

    const response=await fetch("http://127.0.0.1:9000/ask",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({question})
    });

    const data=await response.json();
    chats[currentChatId].push({type:"bot",text:data.answer});
    renderMessages(); saveChats();
}

async function sendImage(){
    const file=document.getElementById("imageInput").files[0];
    if(!file){alert("Image à®¤à¯‡à®°à¯à®µà¯ à®šà¯†à®¯à¯à®¯à®µà¯à®®à¯");return;}
    if(!currentChatId) newChat();

    const formData=new FormData();
    formData.append("file",file);

    chats[currentChatId].push({type:"user",text:"ğŸ“· Image Question"});
    renderMessages(); saveChats();

    const response=await fetch("http://127.0.0.1:9000/image-question",{
        method:"POST",
        body:formData
    });

    const data=await response.json();
    chats[currentChatId].push({type:"bot",text:data.answer});
    renderMessages(); saveChats();
}

function startVoice(){
    if(!('webkitSpeechRecognition'in window)){alert("Voice support à®‡à®²à¯à®²à¯ˆ");return;}
    const recognition=new webkitSpeechRecognition();
    recognition.lang="ta-IN";
    recognition.start();
    recognition.onresult=function(event){
        document.getElementById("question").value=
        event.results[0][0].transcript;
    };
}

function speakText(text){
    window.speechSynthesis.cancel(); // ğŸ”¥ stop previous speech

    if(!voiceEnabled) return;

    const speech=new SpeechSynthesisUtterance(text);
    speech.lang="ta-IN";
    window.speechSynthesis.speak(speech);
}

function manualSpeak(btn){
    const text = btn.parentElement.innerText.replace("ğŸ”Š à®•à¯‡à®³à¯","");
    window.speechSynthesis.cancel();
    const speech=new SpeechSynthesisUtterance(text);
    speech.lang="ta-IN";
    window.speechSynthesis.speak(speech);
}

function toggleVoice(){
    voiceEnabled=!voiceEnabled;
    const btn=document.getElementById("voiceToggle");

    if(!voiceEnabled){
        window.speechSynthesis.cancel(); // ğŸ”¥ immediately stop when OFF
    }

    btn.innerText=voiceEnabled?"ğŸ”Š Voice ON":"ğŸ”‡ Voice OFF";
}

renderChatList();

</script>

</body>
</html>
